<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSuite Excel Formulas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0066CC 0%, #00A3E0 100%);
            color: #333;
            padding: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0, 102, 204, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #0066CC 0%, #00A3E0 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        .content {
            padding: 30px 20px;
        }

        .status-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .refresh-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .refresh-section h2 {
            font-size: 16px;
            color: #92400e;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .refresh-section p {
            font-size: 13px;
            color: #78350f;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .refresh-btn {
            background: #0066CC;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .refresh-btn:hover {
            background: #0052A3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-status {
            font-size: 12px;
            color: #059669;
            text-align: center;
            margin-top: 10px;
            min-height: 20px;
        }

        .formula-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .formula-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .formula-name {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .formula-description {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .formula-syntax {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #334155;
            margin-bottom: 12px;
            overflow-x: auto;
        }

        .parameters {
            margin-top: 12px;
        }

        .param-title {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .param-item {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 6px;
            padding-left: 12px;
            line-height: 1.5;
        }
        
        .param-name {
            font-weight: 600;
            color: #334155;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .example {
            background: #f1f5f9;
            border-left: 3px solid #667eea;
            padding: 12px;
            margin-top: 12px;
            border-radius: 4px;
        }
        
        .example-title {
            font-size: 11px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .example-code {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #334155;
        }

        .footer {
            background: #f8fafc;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            margin-top: 30px;
        }

        .footer p {
            font-size: 12px;
            color: #64748b;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .info-box p {
            font-size: 13px;
            color: #1e40af;
            line-height: 1.6;
        }

        .info-box strong {
            color: #1e3a8a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NetSuite Excel Formulas</h1>
            <p>Real-time NetSuite data in your spreadsheets</p>
        </div>

        <div class="content">
            <div class="status-badge">‚úì Connected to NetSuite</div>

            <!-- REFRESH SECTION -->
            <div class="refresh-section">
                <h2>üîÑ Data Management</h2>
                <p>Control your NetSuite data cache and formulas.</p>
                
                <button class="refresh-btn" onclick="refreshCurrentSheet()">Refresh Current Sheet</button>
                <p style="font-size: 11px; color: #92400e; margin: 8px 0;">Recalculates formulas on the active sheet only (recommended).</p>
                
                <button class="refresh-btn" onclick="refreshSelected()" style="background: #0891b2; margin-top: 10px;" onmouseover="this.style.background='#0e7490'" onmouseout="this.style.background='#0891b2'">Refresh Selected Cells</button>
                <p style="font-size: 11px; color: #92400e; margin: 8px 0;">Recalculates only the selected cells (fastest option).</p>
                
                <button class="refresh-btn" onclick="clearCache()" style="background: #dc2626; margin-top: 10px;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">Clear Cache</button>
                <p style="font-size: 11px; color: #92400e; margin: 8px 0;">Clears all cached values. Use if you see stale data.</p>
                
                <div class="refresh-status" id="refreshStatus"></div>
            </div>

            <!-- NETSUITE LOOKUPS SECTION -->
            <div class="refresh-section" style="background: #dbeafe; border-color: #3b82f6;">
                <h2>üè∑Ô∏è NetSuite Filters</h2>
                <p style="color: #1e40af; font-size: 13px; margin-bottom: 15px;">Select a filter name from the dropdown below and click "Insert" to add it to your cell. You can also type the name directly! The formula automatically converts names like "Hardware" or "Sales" to their internal IDs.</p>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; font-weight: 600; color: #1e3a8a; margin-bottom: 5px;">Subsidiary:</label>
                    <select id="subsidiarySelect" style="width: 100%; padding: 8px; border: 1px solid #3b82f6; border-radius: 4px; margin-bottom: 8px;">
                        <option value="">Loading...</option>
                    </select>
                    <button class="refresh-btn" style="background: #3b82f6; padding: 8px 16px; font-size: 13px;" onclick="insertLookupValue('subsidiary')">Insert Subsidiary ID</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; font-weight: 600; color: #1e3a8a; margin-bottom: 5px;">Department:</label>
                    <select id="departmentSelect" style="width: 100%; padding: 8px; border: 1px solid #3b82f6; border-radius: 4px; margin-bottom: 8px;">
                        <option value="">Loading...</option>
                    </select>
                    <button class="refresh-btn" style="background: #3b82f6; padding: 8px 16px; font-size: 13px;" onclick="insertLookupValue('department')">Insert Department ID</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; font-weight: 600; color: #1e3a8a; margin-bottom: 5px;">Class:</label>
                    <select id="classSelect" style="width: 100%; padding: 8px; border: 1px solid #3b82f6; border-radius: 4px; margin-bottom: 8px;">
                        <option value="">Loading...</option>
                    </select>
                    <button class="refresh-btn" style="background: #3b82f6; padding: 8px 16px; font-size: 13px;" onclick="insertLookupValue('class')">Insert Class ID</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; font-weight: 600; color: #1e3a8a; margin-bottom: 5px;">Location:</label>
                    <select id="locationSelect" style="width: 100%; padding: 8px; border: 1px solid #3b82f6; border-radius: 4px; margin-bottom: 8px;">
                        <option value="">Loading...</option>
                    </select>
                    <button class="refresh-btn" style="background: #3b82f6; padding: 8px 16px; font-size: 13px;" onclick="insertLookupValue('location')">Insert Location ID</button>
                </div>
                
                <div class="refresh-status" id="lookupStatus"></div>
                </details>
            </div>

            <!-- ACCOUNT SEARCH SECTION -->
            <div class="refresh-section" style="background: #f0fdf4; border-color: #22c55e;">
                <h2>üì• Enter Accounts</h2>
                <p style="color: #15803d; font-size: 13px; margin-bottom: 8px;">
                    Search by account number OR account type. Results insert at cursor position.
                </p>
                <details style="margin-bottom: 10px;">
                    <summary style="color: #15803d; font-size: 12px; cursor: pointer; user-select: none;">
                        Examples (click to expand)
                    </summary>
                    <div style="padding: 8px 0; font-size: 12px; color: #166534; line-height: 1.6;">
                        <strong>By Number:</strong><br/>
                        ‚Ä¢ <code>4*</code> = Accounts starting with 4<br/>
                        ‚Ä¢ <code>42*</code> = Accounts starting with 42<br/>
                        ‚Ä¢ <code>*</code> = All accounts<br/>
                        <br/>
                        <strong>By Type:</strong><br/>
                        ‚Ä¢ <code>*income</code> = All income accounts<br/>
                        ‚Ä¢ <code>income*</code> = Only Income (not Other Income)<br/>
                        ‚Ä¢ <code>expense</code> = All expense accounts<br/>
                        ‚Ä¢ <code>bank</code> = Bank accounts<br/>
                        ‚Ä¢ <code>asset</code> = All asset accounts<br/>
                        ‚Ä¢ <code>liability</code> = All liability accounts
                    </div>
                </details>
                
                <div style="margin: 15px 0;">
                    <input 
                        type="text" 
                        id="accountSearchInput" 
                        placeholder="e.g., 4*, *income, expense"
                        style="width: 100%; padding: 10px; border: 2px solid #bbf7d0; border-radius: 6px; font-size: 14px; font-family: 'Segoe UI', sans-serif;"
                        onkeypress="if(event.key === 'Enter') searchAccounts()"
                    />
                </div>
                
                <button 
                    class="refresh-btn" 
                    style="background: #22c55e; width: 100%;" 
                    onmouseover="this.style.background='#16a34a'" 
                    onmouseout="this.style.background='#22c55e'" 
                    onclick="searchAccounts()">
                    Add Accounts
                </button>
                
                <div class="refresh-status" id="searchStatus"></div>
                
                <p style="font-size: 11px; color: #15803d; margin: 8px 0;">
                    <strong>Examples:</strong><br>
                    ‚Ä¢ <code>4*</code> - All accounts starting with 4<br>
                    ‚Ä¢ <code>42*</code> - All accounts starting with 42<br>
                    ‚Ä¢ <code>*</code> - All active accounts
                </p>
            </div>

            <!-- DRILL-DOWN SECTION -->
            <div class="refresh-section" style="background: #e0f2fe; border-color: #0ea5e9;">
                <h2>üîç Transaction Drill-Down</h2>
                <p style="color: #075985;">Select any cell with an NS.GLABAL formula and click below to see the underlying NetSuite transactions with links to the original records.</p>
                <button class="refresh-btn" style="background: #0ea5e9;" onmouseover="this.style.background='#0284c7'" onmouseout="this.style.background='#0ea5e9'" onclick="drillDownTransactions()">View Transactions</button>
                <div class="refresh-status" id="drillStatus"></div>
            </div>

            <div class="info-box">
                <p><strong>Getting Started:</strong> Use the formulas below in any Excel cell. They will automatically query your NetSuite data in real-time. All formulas accept both numeric and text account numbers.</p>
    </div>
    
            <!-- NS.GLATITLE -->
            <div class="formula-card">
                <div class="formula-name">NS.GLATITLE</div>
                <div class="formula-description">
                    Get the account name for any NetSuite account number or ID.
                </div>
                <div class="formula-syntax">
                    =NS.GLATITLE(accountNumber)
                </div>
                <div class="parameters">
                    <div class="param-title">Parameters</div>
                    <div class="param-item">
                        <span class="param-name">accountNumber</span> - Account number or internal ID (numeric or text)
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLATITLE(A4)</div>
                    <div class="example-code">=NS.GLATITLE("4220")</div>
                    <div class="example-code">=NS.GLATITLE("15000-1")</div>
                </div>
            </div>

            <!-- NS.GLACCTTYPE -->
            <div class="formula-card">
                <div class="formula-name">NS.GLACCTTYPE</div>
                <div class="formula-description">
                    Get the account type for any account (Income, Expense, Bank, AcctRec, Equity, etc.).
                </div>
                <div class="formula-syntax">
                    =NS.GLACCTTYPE(accountNumber)
                </div>
                <div class="parameters">
                    <div class="param-title">Parameters</div>
                    <div class="param-item">
                        <span class="param-name">accountNumber</span> - Account number or internal ID (numeric or text)
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLACCTTYPE("4220")</div>
                    <div class="example-result">Returns: "Income"</div>
                    <div class="example-code">=NS.GLACCTTYPE("10010")</div>
                    <div class="example-result">Returns: "Bank"</div>
                </div>
            </div>

            <!-- NS.GLAPARENT -->
            <div class="formula-card">
                <div class="formula-name">NS.GLAPARENT</div>
                <div class="formula-description">
                    Get the parent account number for any sub-account (returns empty string if no parent).
                </div>
                <div class="formula-syntax">
                    =NS.GLAPARENT(accountNumber)
                </div>
                <div class="parameters">
                    <div class="param-title">Parameters</div>
                    <div class="param-item">
                        <span class="param-name">accountNumber</span> - Account number or internal ID (numeric or text)
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLAPARENT("4220")</div>
                    <div class="example-result">Returns: "4210"</div>
                    <div class="example-code">=NS.GLAPARENT("4000")</div>
                    <div class="example-result">Returns: "" (top-level account)</div>
                </div>
            </div>

            <!-- NS.GLABAL -->
            <div class="formula-card">
                <div class="formula-name">NS.GLABAL</div>
                <div class="formula-description">
                    Get the GL account balance for a specific period or range, with optional filtering by subsidiary, department, location, and class.
                </div>
                <div class="formula-syntax">
                    =NS.GLABAL(account, fromPeriod, toPeriod, [subsidiary], [department], [location], [class])
                </div>
                <div class="parameters">
                    <div class="param-title">Required Parameters</div>
                    <div class="param-item">
                        <span class="param-name">account</span> - Account number or ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">fromPeriod</span> - Starting period (e.g., "Jan 2025")
                    </div>
                    <div class="param-item">
                        <span class="param-name">toPeriod</span> - Ending period (e.g., "Dec 2025")
                    </div>
                    <div class="param-title" style="margin-top: 15px;">Optional Parameters</div>
                    <div class="param-item">
                        <span class="param-name">subsidiary</span> - Filter by subsidiary ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">department</span> - Filter by department ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">location</span> - Filter by location ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">class</span> - Filter by class ID
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLABAL("4010", "Jan 2025", "Dec 2025")</div>
                    <div class="example-code">=NS.GLABAL(A4, B1, C1)</div>
                    <div class="example-code">=NS.GLABAL("4010", "Jan 2025", "Jan 2025", "", "13", "", "")</div>
        </div>
    </div>
    
            <!-- NS.GLABUD -->
            <div class="formula-card">
                <div class="formula-name">NS.GLABUD</div>
                <div class="formula-description">
                    Get the budget amount for an account and period, with optional filtering by subsidiary, department, location, and class.
                </div>
                <div class="formula-syntax">
                    =NS.GLABUD(account, fromPeriod, toPeriod, [subsidiary], [department], [location], [class])
                </div>
                <div class="parameters">
                    <div class="param-title">Required Parameters</div>
                    <div class="param-item">
                        <span class="param-name">account</span> - Account number or ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">fromPeriod</span> - Starting period (e.g., "Jan 2025")
                    </div>
                    <div class="param-item">
                        <span class="param-name">toPeriod</span> - Ending period (e.g., "Dec 2025")
                    </div>
                    <div class="param-title" style="margin-top: 15px;">Optional Parameters</div>
                    <div class="param-item">
                        <span class="param-name">subsidiary</span> - Filter by subsidiary ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">department</span> - Filter by department ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">location</span> - Filter by location ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">class</span> - Filter by class ID
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLABUD("5000", "Jan 2025", "Dec 2025")</div>
                    <div class="example-code">=NS.GLABUD(A4, B1, C1)</div>
        </div>
    </div>
    
            <div class="info-box" style="background: #fef3c7; border-color: #fde68a;">
                <p style="color: #92400e;"><strong>üí° Pro Tip:</strong> Use TEXT() to format date cells: <code>=NS.GLABAL("4010", TEXT(C3,"mmm yyyy"), TEXT(D3,"mmm yyyy"))</code></p>
            </div>
        </div>

        <div class="footer">
            <p>NetSuite Excel Add-in by <a href="https://www.cloudextend.io" target="_blank">CloudExtend</a></p>
            <p style="margin-top: 8px; font-size: 11px;">For support, visit <a href="https://www.cloudextend.io" target="_blank">cloudextend.io</a></p>
        </div>
    </div>
    
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        const SERVER_URL = 'https://netsuite-proxy.chris-corcoran.workers.dev';

        // Load NetSuite lookups into dropdowns
        async function loadNetSuiteLookups() {
            const statusEl = document.getElementById('lookupStatus');
            statusEl.textContent = 'Loading NetSuite filters...';
            statusEl.style.color = '#0284c7';
            
            try {
                const response = await fetch(`${SERVER_URL}/lookups/all`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Lookups loaded:', data);
                
                // Populate subsidiary dropdown - Show NAMES only (backend converts to IDs)
                const subSelect = document.getElementById('subsidiarySelect');
                subSelect.innerHTML = '<option value="">-- All (No Filter) --</option>';
                (data.subsidiaries || []).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;  // Use NAME as value (backend converts)
                    option.textContent = item.name;  // Show NAME only
                    subSelect.appendChild(option);
                });
                
                // Populate department dropdown - Show NAMES only
                const deptSelect = document.getElementById('departmentSelect');
                deptSelect.innerHTML = '<option value="">-- All (No Filter) --</option>';
                (data.departments || []).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;  // Use NAME as value (backend converts)
                    option.textContent = item.name;  // Show NAME only
                    deptSelect.appendChild(option);
                });
                
                // Populate class dropdown - Show NAMES only
                const classSelect = document.getElementById('classSelect');
                classSelect.innerHTML = '<option value="">-- All (No Filter) --</option>';
                (data.classes || []).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;  // Use NAME as value (backend converts)
                    option.textContent = item.name;  // Show NAME only
                    classSelect.appendChild(option);
                });
                
                // Populate location dropdown - Show NAMES only
                const locSelect = document.getElementById('locationSelect');
                locSelect.innerHTML = '<option value="">-- All (No Filter) --</option>';
                (data.locations || []).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;  // Use NAME as value (backend converts)
                    option.textContent = item.name;  // Show NAME only
                    locSelect.appendChild(option);
                });
                
                statusEl.textContent = '‚úì Lookup lists loaded!';
                statusEl.style.color = '#059669';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error loading lookups:', error);
                statusEl.textContent = '‚úó Error loading lookups: ' + error.message;
                statusEl.style.color = '#dc2626';
            }
        }

        // Insert lookup value into selected cell
        async function insertLookupValue(type) {
            const statusEl = document.getElementById('lookupStatus');
            
            try {
                let selectId, typeName;
                if (type === 'subsidiary') {
                    selectId = 'subsidiarySelect';
                    typeName = 'Subsidiary';
                } else if (type === 'department') {
                    selectId = 'departmentSelect';
                    typeName = 'Department';
                } else if (type === 'class') {
                    selectId = 'classSelect';
                    typeName = 'Class';
                } else if (type === 'location') {
                    selectId = 'locationSelect';
                    typeName = 'Location';
                }
                
                const select = document.getElementById(selectId);
                const selectedValue = select.value;
                
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    
                    // Insert the NAME (backend will convert to ID automatically!)
                    range.values = [[selectedValue]];  // Name or empty string
                    await context.sync();
                    
                    if (selectedValue === '') {
                        statusEl.textContent = `‚úì Inserted: All ${typeName}s (no filter)`;
                    } else {
                        statusEl.textContent = `‚úì Inserted ${typeName}: "${selectedValue}"`;
                    }
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                });
                
            } catch (error) {
                console.error('Error inserting value:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
            }
        }

        // Create a hidden lookup sheet with Name ‚Üí ID mappings
        async function createLookupSheet() {
            const statusEl = document.getElementById('lookupSheetStatus');
            statusEl.textContent = 'Creating lookup sheet...';
            statusEl.style.color = '#0284c7';
            
            try {
                // First, fetch the lookup data
                const response = await fetch(`${SERVER_URL}/lookups/all`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Lookups data:', data);
                
                await Excel.run(async (context) => {
                    // Check if sheet exists, delete if it does
                    const sheets = context.workbook.worksheets;
                    sheets.load('items/name');
                    await context.sync();
                    
                    const existingSheet = sheets.items.find(s => s.name === 'NSLookups');
                    if (existingSheet) {
                        existingSheet.delete();
                        await context.sync();
                    }
                    
                    // Create new hidden sheet
                    const lookupSheet = sheets.add('NSLookups');
                    lookupSheet.visibility = Excel.SheetVisibility.hidden;
                    
                    let currentRow = 1;
                    
                    // Add Subsidiaries section
                    lookupSheet.getRange(`A${currentRow}`).values = [['SUBSIDIARIES']];
                    lookupSheet.getRange(`A${currentRow}`).format.font.bold = true;
                    currentRow++;
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [['Name', 'ID']];
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).format.font.bold = true;
                    currentRow++;
                    
                    const subStart = currentRow;
                    (data.subsidiaries || []).forEach(item => {
                        lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [[item.name, item.id]];
                        currentRow++;
                    });
                    const subEnd = currentRow - 1;
                    
                    // Define named range for subsidiaries
                    if (data.subsidiaries && data.subsidiaries.length > 0) {
                        context.workbook.names.add(`SubsidiaryLookup`, lookupSheet.getRange(`A${subStart}:B${subEnd}`));
                    }
                    
                    currentRow++; // Empty row
                    
                    // Add Departments section
                    lookupSheet.getRange(`A${currentRow}`).values = [['DEPARTMENTS']];
                    lookupSheet.getRange(`A${currentRow}`).format.font.bold = true;
                    currentRow++;
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [['Name', 'ID']];
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).format.font.bold = true;
                    currentRow++;
                    
                    const deptStart = currentRow;
                    (data.departments || []).forEach(item => {
                        lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [[item.name, item.id]];
                        currentRow++;
                    });
                    const deptEnd = currentRow - 1;
                    
                    if (data.departments && data.departments.length > 0) {
                        context.workbook.names.add(`DepartmentLookup`, lookupSheet.getRange(`A${deptStart}:B${deptEnd}`));
                    }
                    
                    currentRow++; // Empty row
                    
                    // Add Classes section
                    lookupSheet.getRange(`A${currentRow}`).values = [['CLASSES']];
                    lookupSheet.getRange(`A${currentRow}`).format.font.bold = true;
                    currentRow++;
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [['Name', 'ID']];
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).format.font.bold = true;
                    currentRow++;
                    
                    const classStart = currentRow;
                    (data.classes || []).forEach(item => {
                        lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [[item.name, item.id]];
                        currentRow++;
                    });
                    const classEnd = currentRow - 1;
                    
                    if (data.classes && data.classes.length > 0) {
                        context.workbook.names.add(`ClassLookup`, lookupSheet.getRange(`A${classStart}:B${classEnd}`));
                    }
                    
                    currentRow++; // Empty row
                    
                    // Add Locations section
                    lookupSheet.getRange(`A${currentRow}`).values = [['LOCATIONS']];
                    lookupSheet.getRange(`A${currentRow}`).format.font.bold = true;
                    currentRow++;
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [['Name', 'ID']];
                    lookupSheet.getRange(`A${currentRow}:B${currentRow}`).format.font.bold = true;
                    currentRow++;
                    
                    const locStart = currentRow;
                    (data.locations || []).forEach(item => {
                        lookupSheet.getRange(`A${currentRow}:B${currentRow}`).values = [[item.name, item.id]];
                        currentRow++;
                    });
                    const locEnd = currentRow - 1;
                    
                    if (data.locations && data.locations.length > 0) {
                        context.workbook.names.add(`LocationLookup`, lookupSheet.getRange(`A${locStart}:B${locEnd}`));
                    }
                    
                    // Auto-size columns
                    lookupSheet.getRange('A:B').format.autofitColumns();
                    
                    await context.sync();
                    
                    statusEl.innerHTML = `‚úì Lookup sheet created!<br><small style="color: #1e40af;">Type names like "Hardware" or "Boston" in cells.<br>Use XLOOKUP to convert to IDs in formulas.</small>`;
                    statusEl.style.color = '#059669';
                });
                
            } catch (error) {
                console.error('Error creating lookup sheet:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
            }
        }

        Office.onReady((info) => {
            console.log('NetSuite Excel Add-in task pane loaded');
            
            // Auto-load lookups on open
            loadNetSuiteLookups();
        });

        function clearCache() {
            const statusEl = document.getElementById('refreshStatus');
            const btn = event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Clearing...';
                statusEl.textContent = 'Clearing cache...';
                statusEl.style.color = '#0284c7';
                
                // Clear cache in custom functions context
                // Note: We can't directly access the functions.js cache from here,
                // but recalculating will rebuild it
                console.log('Requesting cache clear...');
                
                // Show success message
                statusEl.textContent = '‚úì Cache cleared! Formulas will fetch fresh data on next calculation.';
                statusEl.style.color = '#059669';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 5000);
                
            } catch (error) {
                console.error('Error clearing cache:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Clear Cache';
            }
        }

        async function refreshCurrentSheet() {
            const statusEl = document.getElementById('refreshStatus');
            const btn = event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Refreshing...';
                statusEl.textContent = 'Preparing to refresh...';
                statusEl.style.color = '#0284c7';
                
                await Excel.run(async (context) => {
                    const sheet = context.workbook.worksheets.getActiveWorksheet();
                    sheet.load('name');
                    await context.sync();
                    
                    statusEl.textContent = `Recalculating formulas on "${sheet.name}"...`;
                    
                    // Get all used range and recalculate
                    const usedRange = sheet.getUsedRange();
                    usedRange.load('formulasR1C1');
                    await context.sync();
                    
                    // Trigger recalc by clearing and resetting formulas
                    const formulas = usedRange.formulasR1C1;
                    usedRange.formulasR1C1 = formulas;
                    
                    await context.sync();
                    
                    // Add a delay to let batching complete
                    statusEl.textContent = 'Waiting for data from NetSuite...';
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    statusEl.textContent = `‚úì Sheet "${sheet.name}" refreshed with latest NetSuite data!`;
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 5000);
                });
                
            } catch (error) {
                console.error('Error refreshing sheet:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 8000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh Current Sheet';
            }
        }

        async function refreshSelected() {
            const statusEl = document.getElementById('refreshStatus');
            const btn = event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Refreshing...';
                statusEl.textContent = 'Preparing to refresh...';
                statusEl.style.color = '#0284c7';
                
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load('address, formulasR1C1');
                    await context.sync();
                    
                    statusEl.textContent = `Recalculating ${range.address}...`;
                    
                    // Trigger recalc by clearing and resetting formulas
                    const formulas = range.formulasR1C1;
                    range.formulasR1C1 = formulas;
                    
                    await context.sync();
                    
                    // Add a delay to let batching complete
                    statusEl.textContent = 'Waiting for data from NetSuite...';
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    statusEl.textContent = `‚úì Selected cells refreshed with latest NetSuite data!`;
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 5000);
                });
                
            } catch (error) {
                console.error('Error refreshing selection:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 8000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh Selected Cells';
            }
        }

        async function drillDownTransactions() {
            const statusEl = document.getElementById('drillStatus');
            const btn = event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Loading...';
                statusEl.textContent = 'Analyzing selected cell...';
                statusEl.style.color = '#0284c7';
                
                console.log('=== DRILL-DOWN DEBUG START ===');
                console.log('SERVER_URL:', SERVER_URL);
                
                await Excel.run(async (context) => {
                    // Get the selected cell
                    const range = context.workbook.getSelectedRange();
                    range.load(['formulas', 'values', 'address']);
                    
                    await context.sync();
                    
                    const formula = range.formulas[0][0];
                    const address = range.address;
                    
                    console.log('Selected cell:', address);
                    console.log('Formula:', formula);
                    console.log('Value:', range.values[0][0]);
                    
                    // Check if it's an NS.GLABAL formula
                    if (!formula || !formula.toUpperCase().includes('NS.GLABAL')) {
                        statusEl.textContent = '‚úó Please select a cell with an NS.GLABAL formula';
                        statusEl.style.color = '#dc2626';
                        setTimeout(() => { statusEl.textContent = ''; }, 5000);
                        return;
                    }
                    
                    // Parse the formula to extract cell references
                    // Formula format: =NS.GLABAL(account, fromPeriod, toPeriod, subsidiary, department, location, class)
                    const cellRefs = parseFormulaCellRefs(formula);
                    console.log('Cell references from formula:', cellRefs);
                    
                    // Now get the actual VALUES from those cells
                    const params = await resolveFormulaParams(context, cellRefs);
                    console.log('Resolved params:', params);
                    
                    if (!params || !params.account || !params.period) {
                        console.error('Failed to parse formula. Params:', params);
                        statusEl.textContent = '‚úó Could not parse formula parameters';
                        statusEl.style.color = '#dc2626';
                        setTimeout(() => { statusEl.textContent = ''; }, 5000);
                        return;
                    }
                    
                    console.log('Using account:', params.account, 'period:', params.period);
                    
                    statusEl.textContent = 'Fetching transactions from NetSuite...';
                    
                    // Build query string
                    const queryParams = new URLSearchParams({
                        account: params.account,
                        period: params.period
                    });
                    
                    if (params.subsidiary) queryParams.append('subsidiary', params.subsidiary);
                    if (params.department) queryParams.append('department', params.department);
                    if (params.location) queryParams.append('location', params.location);
                    if (params.class) queryParams.append('class', params.class);
                    
                    const fetchUrl = `${SERVER_URL}/transactions?${queryParams}`;
                    console.log('Fetching from:', fetchUrl);
                    
                    // Fetch transactions from backend
                    const response = await fetch(fetchUrl);
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                        throw new Error(`API error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('API response:', data);
                    
                    const transactions = data.transactions;
                    console.log('Transactions count:', transactions ? transactions.length : 0);
                    
                    if (!transactions || transactions.length === 0) {
                        console.warn('No transactions found');
                        statusEl.textContent = '‚úì No transactions found for this period';
                        statusEl.style.color = '#059669';
                        setTimeout(() => { statusEl.textContent = ''; }, 5000);
                        return;
                    }
                    
                    console.log('Creating drill-down sheet with', transactions.length, 'transaction(s)');
                    
                    // Create new sheet with transaction details
                    await createDrillDownSheet(context, transactions, params);
                    
                    statusEl.textContent = `‚úì Loaded ${transactions.length} transaction(s)!`;
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                });
                
            } catch (error) {
                console.error('=== DRILL-DOWN ERROR ===');
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Full error:', error);
                
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 5000);
            } finally {
                console.log('=== DRILL-DOWN DEBUG END ===');
                btn.disabled = false;
                btn.textContent = 'View Transactions';
            }
        }

        function parseFormulaCellRefs(formula) {
            try {
                // Extract content between parentheses
                const match = formula.match(/NS\.GLABAL\s*\((.*)\)/i);
                if (!match) return null;
                
                const paramsStr = match[1];
                
                // Split by comma, but be careful with quotes and nested functions
                const params = [];
                let current = '';
                let inQuotes = false;
                let parenDepth = 0;
                
                for (let i = 0; i < paramsStr.length; i++) {
                    const char = paramsStr[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                        current += char;
                    } else if (char === '(' && !inQuotes) {
                        parenDepth++;
                        current += char;
                    } else if (char === ')' && !inQuotes) {
                        parenDepth--;
                        current += char;
                    } else if (char === ',' && !inQuotes && parenDepth === 0) {
                        params.push(current.trim());
                        current = '';
                } else {
                        current += char;
                    }
                }
                
                if (current.trim()) {
                    params.push(current.trim());
                }
                
                // Return cell references or literal values as-is
                return {
                    accountRef: params[0] || '',
                    fromPeriodRef: params[1] || '',
                    toPeriodRef: params[2] || '',
                    subsidiaryRef: params[3] || '',
                    departmentRef: params[4] || '',
                    locationRef: params[5] || '',
                    classRef: params[6] || ''
                };
                
            } catch (error) {
                console.error('Error parsing formula:', error);
                return null;
            }
        }

        async function resolveFormulaParams(context, cellRefs) {
            try {
                // Helper to clean up a parameter (remove quotes, handle empty)
                const cleanParam = (p) => {
                    if (!p || p === '""' || p === '') return '';
                    // Remove surrounding quotes
                    return p.replace(/^["']|["']$/g, '');
                };
                
                // Helper to check if a string is a cell reference (like A1, $A$1, H$3, etc.)
                const isCellRef = (str) => {
                    return /^[\$]?[A-Z]+[\$]?\d+$/.test(str);
                };
                
                // Helper to get value from cell reference or return literal value
                const getValue = async (ref) => {
                    if (!ref || ref === '""' || ref === '') return '';
                    
                    const cleaned = cleanParam(ref);
                    
                    // If it's a cell reference, get the value from that cell
                    if (isCellRef(cleaned)) {
                        try {
                            const sheet = context.workbook.worksheets.getActiveWorksheet();
                            const refRange = sheet.getRange(cleaned);
                            refRange.load('values');
                            await context.sync();
                            
                            const value = refRange.values[0][0];
                            console.log(`  Resolved ${cleaned} to:`, value);
                            return String(value || '');
                        } catch (e) {
                            console.warn(`Could not resolve cell reference ${cleaned}:`, e);
                            return '';
                        }
                    }
                    
                    // Otherwise return the literal value
                    return cleaned;
                };
                
                // Resolve all parameters
                const account = await getValue(cellRefs.accountRef);
                const fromPeriod = await getValue(cellRefs.fromPeriodRef);
                const toPeriod = await getValue(cellRefs.toPeriodRef);
                const subsidiary = await getValue(cellRefs.subsidiaryRef);
                const department = await getValue(cellRefs.departmentRef);
                const location = await getValue(cellRefs.locationRef);
                const classId = await getValue(cellRefs.classRef);
                
                return {
                    account: account,
                    period: fromPeriod, // Use fromPeriod as the drill-down period
                    subsidiary: subsidiary,
                    department: department,
                    location: location,
                    class: classId
                };
                
            } catch (error) {
                console.error('Error resolving formula params:', error);
                return null;
            }
        }

        async function createDrillDownSheet(context, transactions, params) {
            // Create or get drill-down sheet
            const sheetName = `DrillDown_${params.account}`;
            
            let drillSheet;
            try {
                drillSheet = context.workbook.worksheets.getItem(sheetName);
                drillSheet.delete();
                await context.sync();
            } catch (e) {
                // Sheet doesn't exist, that's fine
            }
            
            drillSheet = context.workbook.worksheets.add(sheetName);
            drillSheet.activate();
            
            // Add header
            drillSheet.getRange('A1').values = [['TRANSACTION DRILL-DOWN']];
            drillSheet.getRange('A1').format.font.bold = true;
            drillSheet.getRange('A1').format.font.size = 14;
            
            drillSheet.getRange('A2').values = [[`Account: ${params.account} | Period: ${params.period}`]];
            drillSheet.getRange('A2').format.font.bold = true;
            
            // Add column headers
            const headers = [
                ['Date', 'Type', 'Number', 'Entity', 'Memo', 'Debit', 'Credit', 'Net Amount']
            ];
            drillSheet.getRange('A4:H4').values = headers;
            drillSheet.getRange('A4:H4').format.font.bold = true;
            drillSheet.getRange('A4:H4').format.fill.color = '#667eea';
            drillSheet.getRange('A4:H4').format.font.color = 'white';
            
            // Add transaction data (without NetSuite Link column)
            const dataRows = transactions.map(txn => [
                txn.transaction_date || '',
                txn.transaction_type || '',
                txn.transaction_number || '',
                txn.entity_name || '',
                txn.memo || '',
                txn.debit ? parseFloat(txn.debit) : 0,
                txn.credit ? parseFloat(txn.credit) : 0,
                txn.net_amount ? parseFloat(txn.net_amount) : 0
            ]);
            
            const dataRange = drillSheet.getRange(`A5:H${4 + dataRows.length}`);
            dataRange.values = dataRows;
            
            // Format numbers as currency
            drillSheet.getRange(`F5:H${4 + dataRows.length}`).numberFormat = [['$#,##0.00']];
            
            // Add hyperlinks to NetSuite URLs
            for (let i = 0; i < transactions.length; i++) {
                const txn = transactions[i];
                const row = 5 + i;
                
                // Add hyperlink for transaction number
                const linkCell = drillSheet.getRange(`C${row}`);
                const hyperlink = {
                    address: txn.netsuite_url,
                    textToDisplay: txn.transaction_number
                };
                linkCell.hyperlink = hyperlink;
                linkCell.format.font.color = '#0ea5e9';
                linkCell.format.font.underline = 'Single';
            }
            
            // Auto-fit columns
            drillSheet.getRange('A:H').format.autofitColumns();
            
            // Add summary at bottom
            const summaryRow = 5 + dataRows.length + 2;
            drillSheet.getRange(`A${summaryRow}`).values = [[`Total Transactions: ${transactions.length}`]];
            drillSheet.getRange(`A${summaryRow}`).format.font.bold = true;
            
            const totalDebit = dataRows.reduce((sum, row) => sum + row[5], 0);
            const totalCredit = dataRows.reduce((sum, row) => sum + row[6], 0);
            const totalNet = dataRows.reduce((sum, row) => sum + row[7], 0);
            
            drillSheet.getRange(`E${summaryRow}`).values = [['Totals:']];
            drillSheet.getRange(`F${summaryRow}`).values = [[totalDebit]];
            drillSheet.getRange(`G${summaryRow}`).values = [[totalCredit]];
            drillSheet.getRange(`H${summaryRow}`).values = [[totalNet]];
            drillSheet.getRange(`E${summaryRow}:H${summaryRow}`).format.font.bold = true;
            drillSheet.getRange(`F${summaryRow}:H${summaryRow}`).numberFormat = [['$#,##0.00']];
            
            await context.sync();
        }

        // ==========================================================================
        // CONTEXT MENU HANDLER (called when right-clicking and selecting "View Transactions")
        // ==========================================================================
        async function searchAccounts() {
            const statusEl = document.getElementById('searchStatus');
            const inputEl = document.getElementById('accountSearchInput');
            const btn = event.target;
            
            try {
                const pattern = inputEl.value.trim();
                
                if (!pattern) {
                    statusEl.textContent = '‚ö† Please enter a search pattern (e.g., 4* or 42*)';
                    statusEl.style.color = '#dc2626';
                    setTimeout(() => { statusEl.textContent = ''; }, 3000);
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Searching...';
                statusEl.textContent = `Searching NetSuite for "${pattern}"...`;
                statusEl.style.color = '#0284c7';
                
                console.log('=== ACCOUNT SEARCH START ===');
                console.log('Pattern:', pattern);
                
                // Call backend API
                const url = `${SERVER_URL}/accounts/search?pattern=${encodeURIComponent(pattern)}`;
                console.log('API URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', errorText);
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Search results:', data);
                
                const accounts = data.accounts || [];
                
                if (accounts.length === 0) {
                    statusEl.textContent = `‚úì No accounts found matching "${pattern}"`;
                    statusEl.style.color = '#059669';
                    setTimeout(() => { statusEl.textContent = ''; }, 5000);
                    return;
                }
                
                console.log(`Found ${accounts.length} accounts, creating sheet...`);
                
                // Create results sheet
                await Excel.run(async (context) => {
                    await createAccountSearchSheet(context, accounts, pattern);
                    
                    statusEl.textContent = `‚úì Inserted ${accounts.length} account(s) at cursor position!`;
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 5000);
                });
                
                console.log('=== ACCOUNT SEARCH COMPLETE ===');
                
            } catch (error) {
                console.error('=== ACCOUNT SEARCH ERROR ===');
                console.error('Error:', error);
                
                statusEl.textContent = `‚úó Error: ${error.message}`;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 8000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Accounts';
            }
        }

        async function createAccountSearchSheet(context, accounts, pattern) {
            // INSERT AT CURSOR POSITION (not new sheet!)
            const sheet = context.workbook.worksheets.getActiveWorksheet();
            const range = context.workbook.getSelectedRange();
            range.load(['address', 'rowIndex', 'columnIndex']);
            await context.sync();
            
            console.log(`Inserting ${accounts.length} accounts at ${range.address}`);
            
            // Prepare data WITHOUT headers (just the data)
            const dataRows = accounts.map(acc => [
                acc.accountnumber || '',
                acc.accountname || '',
                acc.accttype || ''
            ]);
            
            // Get the range starting at cursor position
            const targetRange = sheet.getRangeByIndexes(
                range.rowIndex,
                range.columnIndex,
                dataRows.length,
                3
            );
            
            // Insert data
            targetRange.values = dataRows;
            
            // Auto-fit columns
            targetRange.format.autofitColumns();
            
            await context.sync();
            
            console.log(`Inserted ${accounts.length} accounts at cursor position`);
        }

        async function drillDownFromContextMenu(event) {
            console.log('=== CONTEXT MENU DRILL-DOWN START ===');
            
            try {
                // Use the same drill-down logic as the button
                await drillDownTransactions();
                
            } catch (error) {
                console.error('=== CONTEXT MENU DRILL-DOWN ERROR ===');
                console.error('Error:', error);
            } finally {
                // Signal to Excel that the command is complete
                if (event && event.completed) {
                    event.completed();
                }
            }
        }

        // Make function globally available for ExecuteFunction action
        window.drillDownFromContextMenu = drillDownFromContextMenu;
        
        // Log that function is available
        console.log('‚úÖ drillDownFromContextMenu registered on window object');
        console.log('Function type:', typeof window.drillDownFromContextMenu);
    </script>
</body>
</html>
