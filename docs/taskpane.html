<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSuite Excel Formulas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        .content {
            padding: 30px 20px;
        }

        .status-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .refresh-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .refresh-section h2 {
            font-size: 16px;
            color: #92400e;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .refresh-section p {
            font-size: 13px;
            color: #78350f;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-status {
            font-size: 12px;
            color: #059669;
            text-align: center;
            margin-top: 10px;
            min-height: 20px;
        }

        .formula-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .formula-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .formula-name {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .formula-description {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .formula-syntax {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #334155;
            margin-bottom: 12px;
            overflow-x: auto;
        }

        .parameters {
            margin-top: 12px;
        }

        .param-title {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .param-item {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 6px;
            padding-left: 12px;
            line-height: 1.5;
        }
        
        .param-name {
            font-weight: 600;
            color: #334155;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .example {
            background: #f1f5f9;
            border-left: 3px solid #667eea;
            padding: 12px;
            margin-top: 12px;
            border-radius: 4px;
        }
        
        .example-title {
            font-size: 11px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .example-code {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #334155;
        }

        .footer {
            background: #f8fafc;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            margin-top: 30px;
        }

        .footer p {
            font-size: 12px;
            color: #64748b;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .info-box p {
            font-size: 13px;
            color: #1e40af;
            line-height: 1.6;
        }

        .info-box strong {
            color: #1e3a8a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NetSuite Excel Formulas</h1>
            <p>Real-time NetSuite data in your spreadsheets</p>
        </div>

        <div class="content">
            <div class="status-badge">‚úì Connected to NetSuite</div>

            <!-- REFRESH SECTION -->
            <div class="refresh-section">
                <h2>üîÑ Refresh NetSuite Data</h2>
                <p>Get the latest data from NetSuite by clicking the button below. This will recalculate all NetSuite formulas in your workbook.</p>
                <button class="refresh-btn" onclick="refreshAllFormulas()">Refresh All Data</button>
                <div class="refresh-status" id="refreshStatus"></div>
            </div>

            <!-- DRILL-DOWN SECTION -->
            <div class="refresh-section" style="background: #e0f2fe; border-color: #0ea5e9;">
                <h2>üîç Transaction Drill-Down</h2>
                <p style="color: #075985;">Select any cell with an NS.GLABAL formula and click below to see the underlying NetSuite transactions with links to the original records.</p>
                <button class="refresh-btn" style="background: #0ea5e9;" onmouseover="this.style.background='#0284c7'" onmouseout="this.style.background='#0ea5e9'" onclick="drillDownTransactions()">View Transactions</button>
                <div class="refresh-status" id="drillStatus"></div>
            </div>

            <div class="info-box">
                <p><strong>Getting Started:</strong> Use the formulas below in any Excel cell. They will automatically query your NetSuite data in real-time. All formulas accept both numeric and text account numbers.</p>
    </div>
    
            <!-- NS.GLATITLE -->
            <div class="formula-card">
                <div class="formula-name">NS.GLATITLE</div>
                <div class="formula-description">
                    Get the account name for any NetSuite account number or ID.
                </div>
                <div class="formula-syntax">
                    =NS.GLATITLE(accountNumber)
                </div>
                <div class="parameters">
                    <div class="param-title">Parameters</div>
                    <div class="param-item">
                        <span class="param-name">accountNumber</span> - Account number or internal ID (numeric or text)
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLATITLE(A4)</div>
                    <div class="example-code">=NS.GLATITLE("4010")</div>
                    <div class="example-code">=NS.GLATITLE(1100)</div>
                </div>
            </div>

            <!-- NS.GLABAL -->
            <div class="formula-card">
                <div class="formula-name">NS.GLABAL</div>
                <div class="formula-description">
                    Get the GL account balance for a specific period or range, with optional filtering by subsidiary, department, location, and class.
                </div>
                <div class="formula-syntax">
                    =NS.GLABAL(account, fromPeriod, toPeriod, [subsidiary], [department], [location], [class])
                </div>
                <div class="parameters">
                    <div class="param-title">Required Parameters</div>
                    <div class="param-item">
                        <span class="param-name">account</span> - Account number or ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">fromPeriod</span> - Starting period (e.g., "Jan 2025")
                    </div>
                    <div class="param-item">
                        <span class="param-name">toPeriod</span> - Ending period (e.g., "Dec 2025")
                    </div>
                    <div class="param-title" style="margin-top: 15px;">Optional Parameters</div>
                    <div class="param-item">
                        <span class="param-name">subsidiary</span> - Filter by subsidiary ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">department</span> - Filter by department ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">location</span> - Filter by location ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">class</span> - Filter by class ID
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLABAL("4010", "Jan 2025", "Dec 2025")</div>
                    <div class="example-code">=NS.GLABAL(A4, B1, C1)</div>
                    <div class="example-code">=NS.GLABAL("4010", "Jan 2025", "Jan 2025", "", "13", "", "")</div>
        </div>
    </div>
    
            <!-- NS.GLABUD -->
            <div class="formula-card">
                <div class="formula-name">NS.GLABUD</div>
                <div class="formula-description">
                    Get the budget amount for an account and period, with optional filtering by subsidiary, department, location, and class.
                </div>
                <div class="formula-syntax">
                    =NS.GLABUD(account, fromPeriod, toPeriod, [subsidiary], [department], [location], [class])
                </div>
                <div class="parameters">
                    <div class="param-title">Required Parameters</div>
                    <div class="param-item">
                        <span class="param-name">account</span> - Account number or ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">fromPeriod</span> - Starting period (e.g., "Jan 2025")
                    </div>
                    <div class="param-item">
                        <span class="param-name">toPeriod</span> - Ending period (e.g., "Dec 2025")
                    </div>
                    <div class="param-title" style="margin-top: 15px;">Optional Parameters</div>
                    <div class="param-item">
                        <span class="param-name">subsidiary</span> - Filter by subsidiary ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">department</span> - Filter by department ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">location</span> - Filter by location ID
                    </div>
                    <div class="param-item">
                        <span class="param-name">class</span> - Filter by class ID
                    </div>
                </div>
                <div class="example">
                    <div class="example-title">Examples</div>
                    <div class="example-code">=NS.GLABUD("5000", "Jan 2025", "Dec 2025")</div>
                    <div class="example-code">=NS.GLABUD(A4, B1, C1)</div>
        </div>
    </div>
    
            <div class="info-box" style="background: #fef3c7; border-color: #fde68a;">
                <p style="color: #92400e;"><strong>üí° Pro Tip:</strong> Use TEXT() to format date cells: <code>=NS.GLABAL("4010", TEXT(C3,"mmm yyyy"), TEXT(D3,"mmm yyyy"))</code></p>
            </div>
        </div>

        <div class="footer">
            <p>NetSuite Excel Add-in by <a href="https://www.cloudextend.io" target="_blank">CloudExtend</a></p>
            <p style="margin-top: 8px; font-size: 11px;">For support, visit <a href="https://www.cloudextend.io" target="_blank">cloudextend.io</a></p>
        </div>
    </div>
    
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        const SERVER_URL = 'https://load-scanner-nathan-targeted.trycloudflare.com';

        Office.onReady((info) => {
            console.log('NetSuite Excel Add-in task pane loaded');
        });

        async function refreshAllFormulas() {
            const statusEl = document.getElementById('refreshStatus');
            const btn = event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Refreshing...';
                statusEl.textContent = 'Recalculating all formulas...';
                statusEl.style.color = '#0284c7';
                
                await Excel.run(async (context) => {
                    // For custom functions, we need to use application.calculate()
                    // This forces a full recalculation including custom functions
                    context.workbook.application.calculate(Excel.CalculationType.full);
                    
                    await context.sync();
                    
                    statusEl.textContent = '‚úì All formulas refreshed with latest NetSuite data!';
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                });
                
            } catch (error) {
                console.error('Error refreshing formulas:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh All Data';
            }
        }

        async function drillDownTransactions() {
            const statusEl = document.getElementById('drillStatus');
            const btn = event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Loading...';
                statusEl.textContent = 'Analyzing selected cell...';
                statusEl.style.color = '#0284c7';
                
                await Excel.run(async (context) => {
                    // Get the selected cell
                    const range = context.workbook.getSelectedRange();
                    range.load(['formulas', 'values', 'address']);
                    
                    await context.sync();
                    
                    const formula = range.formulas[0][0];
                    const address = range.address;
                    
                    console.log('Selected cell:', address, 'Formula:', formula);
                    
                    // Check if it's an NS.GLABAL formula
                    if (!formula || !formula.toUpperCase().includes('NS.GLABAL')) {
                        statusEl.textContent = '‚úó Please select a cell with an NS.GLABAL formula';
                        statusEl.style.color = '#dc2626';
                        setTimeout(() => { statusEl.textContent = ''; }, 5000);
                        return;
                    }
                    
                    // Parse the formula to extract parameters
                    // Formula format: =NS.GLABAL(account, fromPeriod, toPeriod, subsidiary, department, location, class)
                    const params = parseFormulaParams(formula);
                    
                    if (!params || !params.account || !params.period) {
                        statusEl.textContent = '‚úó Could not parse formula parameters';
                        statusEl.style.color = '#dc2626';
                        setTimeout(() => { statusEl.textContent = ''; }, 5000);
                        return;
                    }
                    
                    statusEl.textContent = 'Fetching transactions from NetSuite...';
                    
                    // Build query string
                    const queryParams = new URLSearchParams({
                        account: params.account,
                        period: params.period
                    });
                    
                    if (params.subsidiary) queryParams.append('subsidiary', params.subsidiary);
                    if (params.department) queryParams.append('department', params.department);
                    if (params.location) queryParams.append('location', params.location);
                    if (params.class) queryParams.append('class', params.class);
                    
                    // Fetch transactions from backend
                    const response = await fetch(`${SERVER_URL}/transactions?${queryParams}`);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to fetch transactions');
                    }
                    
                    const data = await response.json();
                    const transactions = data.transactions;
                    
                    if (!transactions || transactions.length === 0) {
                        statusEl.textContent = '‚úì No transactions found for this period';
                        statusEl.style.color = '#059669';
                        setTimeout(() => { statusEl.textContent = ''; }, 5000);
                        return;
                    }
                    
                    // Create new sheet with transaction details
                    await createDrillDownSheet(context, transactions, params);
                    
                    statusEl.textContent = `‚úì Loaded ${transactions.length} transaction(s)!`;
                    statusEl.style.color = '#059669';
                    
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                });
                
            } catch (error) {
                console.error('Error in drill-down:', error);
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.style.color = '#dc2626';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = 'View Transactions';
            }
        }

        function parseFormulaParams(formula) {
            try {
                // Extract content between parentheses
                const match = formula.match(/NS\.GLABAL\s*\((.*)\)/i);
                if (!match) return null;
                
                const paramsStr = match[1];
                
                // Split by comma, but be careful with quotes and nested functions
                const params = [];
                let current = '';
                let inQuotes = false;
                let parenDepth = 0;
                
                for (let i = 0; i < paramsStr.length; i++) {
                    const char = paramsStr[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                        current += char;
                    } else if (char === '(' && !inQuotes) {
                        parenDepth++;
                        current += char;
                    } else if (char === ')' && !inQuotes) {
                        parenDepth--;
                        current += char;
                    } else if (char === ',' && !inQuotes && parenDepth === 0) {
                        params.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                if (current.trim()) {
                    params.push(current.trim());
                }
                
                // Clean up parameters (remove quotes, handle empty strings)
                const cleanParam = (p) => {
                    if (!p || p === '""' || p === '') return '';
                    return p.replace(/^["']|["']$/g, '');
                };
                
                return {
                    account: cleanParam(params[0]),
                    period: cleanParam(params[1]) || cleanParam(params[2]), // Use fromPeriod as the drill-down period
                    subsidiary: cleanParam(params[3]),
                    department: cleanParam(params[4]),
                    location: cleanParam(params[5]),
                    class: cleanParam(params[6])
                };
                
            } catch (error) {
                console.error('Error parsing formula:', error);
                return null;
            }
        }

        async function createDrillDownSheet(context, transactions, params) {
            // Create or get drill-down sheet
            const sheetName = `DrillDown_${params.account}`;
            
            let drillSheet;
            try {
                drillSheet = context.workbook.worksheets.getItem(sheetName);
                drillSheet.delete();
                await context.sync();
            } catch (e) {
                // Sheet doesn't exist, that's fine
            }
            
            drillSheet = context.workbook.worksheets.add(sheetName);
            drillSheet.activate();
            
            // Add header
            drillSheet.getRange('A1').values = [['TRANSACTION DRILL-DOWN']];
            drillSheet.getRange('A1').format.font.bold = true;
            drillSheet.getRange('A1').format.font.size = 14;
            
            drillSheet.getRange('A2').values = [[`Account: ${params.account} | Period: ${params.period}`]];
            drillSheet.getRange('A2').format.font.bold = true;
            
            // Add column headers
            const headers = [
                ['Date', 'Type', 'Number', 'Entity', 'Memo', 'Debit', 'Credit', 'Net Amount', 'NetSuite Link']
            ];
            drillSheet.getRange('A4:I4').values = headers;
            drillSheet.getRange('A4:I4').format.font.bold = true;
            drillSheet.getRange('A4:I4').format.fill.color = '#667eea';
            drillSheet.getRange('A4:I4').format.font.color = 'white';
            
            // Add transaction data
            const dataRows = transactions.map(txn => [
                txn.transaction_date || '',
                txn.transaction_type || '',
                txn.transaction_number || '',
                txn.entity_name || '',
                txn.memo || '',
                txn.debit ? parseFloat(txn.debit) : 0,
                txn.credit ? parseFloat(txn.credit) : 0,
                txn.net_amount ? parseFloat(txn.net_amount) : 0,
                txn.netsuite_url || ''
            ]);
            
            const dataRange = drillSheet.getRange(`A5:I${4 + dataRows.length}`);
            dataRange.values = dataRows;
            
            // Format numbers as currency
            drillSheet.getRange(`F5:H${4 + dataRows.length}`).numberFormat = [['$#,##0.00']];
            
            // Add hyperlinks to NetSuite URLs
            for (let i = 0; i < transactions.length; i++) {
                const txn = transactions[i];
                const row = 5 + i;
                
                // Add hyperlink for transaction number
                const linkCell = drillSheet.getRange(`C${row}`);
                const hyperlink = {
                    address: txn.netsuite_url,
                    textToDisplay: txn.transaction_number
                };
                linkCell.hyperlink = hyperlink;
                linkCell.format.font.color = '#0ea5e9';
                linkCell.format.font.underline = 'Single';
            }
            
            // Auto-fit columns
            drillSheet.getRange('A:I').format.autofitColumns();
            
            // Add summary at bottom
            const summaryRow = 5 + dataRows.length + 2;
            drillSheet.getRange(`A${summaryRow}`).values = [[`Total Transactions: ${transactions.length}`]];
            drillSheet.getRange(`A${summaryRow}`).format.font.bold = true;
            
            const totalDebit = dataRows.reduce((sum, row) => sum + row[5], 0);
            const totalCredit = dataRows.reduce((sum, row) => sum + row[6], 0);
            const totalNet = dataRows.reduce((sum, row) => sum + row[7], 0);
            
            drillSheet.getRange(`E${summaryRow}`).values = [['Totals:']];
            drillSheet.getRange(`F${summaryRow}`).values = [[totalDebit]];
            drillSheet.getRange(`G${summaryRow}`).values = [[totalCredit]];
            drillSheet.getRange(`H${summaryRow}`).values = [[totalNet]];
            drillSheet.getRange(`E${summaryRow}:H${summaryRow}`).format.font.bold = true;
            drillSheet.getRange(`F${summaryRow}:H${summaryRow}`).numberFormat = [['$#,##0.00']];
            
            await context.sync();
        }
    </script>
</body>
</html>
