<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Commands</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        const SERVER_URL = 'https://load-scanner-nathan-targeted.trycloudflare.com';

        Office.onReady(() => {
            console.log('Commands handler loaded');
        });

        // This function is called when the user right-clicks and selects "View NetSuite Transactions"
        async function drillDownFromContextMenu(event) {
            console.log('=== CONTEXT MENU DRILL-DOWN START ===');
            
            try {
                await Excel.run(async (context) => {
                    // Get the selected cell
                    const range = context.workbook.getSelectedRange();
                    range.load(['formulas', 'values', 'address']);
                    
                    await context.sync();
                    
                    const formula = range.formulas[0][0];
                    const address = range.address;
                    
                    console.log('Selected cell:', address);
                    console.log('Formula:', formula);
                    
                    // Check if it's an NS.GLABAL formula
                    if (!formula || !formula.toUpperCase().includes('NS.GLABAL')) {
                        console.warn('Not an NS.GLABAL formula');
                        event.completed();
                        return;
                    }
                    
                    // Parse cell references
                    const cellRefs = parseFormulaCellRefs(formula);
                    console.log('Cell references:', cellRefs);
                    
                    // Resolve to actual values
                    const params = await resolveFormulaParams(context, cellRefs);
                    console.log('Resolved params:', params);
                    
                    if (!params || !params.account || !params.period) {
                        console.error('Could not parse formula parameters');
                        event.completed();
                        return;
                    }
                    
                    // Build query string
                    const queryParams = new URLSearchParams({
                        account: params.account,
                        period: params.period
                    });
                    
                    if (params.subsidiary) queryParams.append('subsidiary', params.subsidiary);
                    if (params.department) queryParams.append('department', params.department);
                    if (params.location) queryParams.append('location', params.location);
                    if (params.class) queryParams.append('class', params.class);
                    
                    const fetchUrl = `${SERVER_URL}/transactions?${queryParams}`;
                    console.log('Fetching from:', fetchUrl);
                    
                    // Fetch transactions
                    const response = await fetch(fetchUrl);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error:', errorText);
                        event.completed();
                        return;
                    }
                    
                    const data = await response.json();
                    const transactions = data.transactions;
                    
                    console.log('Transactions count:', transactions ? transactions.length : 0);
                    
                    if (!transactions || transactions.length === 0) {
                        console.warn('No transactions found');
                        event.completed();
                        return;
                    }
                    
                    // Create drill-down sheet
                    await createDrillDownSheet(context, transactions, params);
                    
                    console.log('=== CONTEXT MENU DRILL-DOWN SUCCESS ===');
                });
                
            } catch (error) {
                console.error('=== CONTEXT MENU DRILL-DOWN ERROR ===');
                console.error('Error:', error);
            } finally {
                event.completed();
            }
        }

        function parseFormulaCellRefs(formula) {
            try {
                const match = formula.match(/NS\.GLABAL\s*\((.*)\)/i);
                if (!match) return null;
                
                const paramsStr = match[1];
                const params = [];
                let current = '';
                let inQuotes = false;
                let parenDepth = 0;
                
                for (let i = 0; i < paramsStr.length; i++) {
                    const char = paramsStr[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                        current += char;
                    } else if (char === '(' && !inQuotes) {
                        parenDepth++;
                        current += char;
                    } else if (char === ')' && !inQuotes) {
                        parenDepth--;
                        current += char;
                    } else if (char === ',' && !inQuotes && parenDepth === 0) {
                        params.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                if (current.trim()) {
                    params.push(current.trim());
                }
                
                return {
                    accountRef: params[0] || '',
                    fromPeriodRef: params[1] || '',
                    toPeriodRef: params[2] || '',
                    subsidiaryRef: params[3] || '',
                    departmentRef: params[4] || '',
                    locationRef: params[5] || '',
                    classRef: params[6] || ''
                };
                
            } catch (error) {
                console.error('Error parsing formula:', error);
                return null;
            }
        }

        async function resolveFormulaParams(context, cellRefs) {
            try {
                const cleanParam = (p) => {
                    if (!p || p === '""' || p === '') return '';
                    return p.replace(/^["']|["']$/g, '');
                };
                
                const isCellRef = (str) => {
                    return /^[\$]?[A-Z]+[\$]?\d+$/.test(str);
                };
                
                const getValue = async (ref) => {
                    if (!ref || ref === '""' || ref === '') return '';
                    
                    const cleaned = cleanParam(ref);
                    
                    if (isCellRef(cleaned)) {
                        try {
                            const sheet = context.workbook.worksheets.getActiveWorksheet();
                            const refRange = sheet.getRange(cleaned);
                            refRange.load('values');
                            await context.sync();
                            
                            const value = refRange.values[0][0];
                            console.log(`  Resolved ${cleaned} to:`, value);
                            return String(value || '');
                        } catch (e) {
                            console.warn(`Could not resolve ${cleaned}:`, e);
                            return '';
                        }
                    }
                    
                    return cleaned;
                };
                
                const account = await getValue(cellRefs.accountRef);
                const fromPeriod = await getValue(cellRefs.fromPeriodRef);
                const toPeriod = await getValue(cellRefs.toPeriodRef);
                const subsidiary = await getValue(cellRefs.subsidiaryRef);
                const department = await getValue(cellRefs.departmentRef);
                const location = await getValue(cellRefs.locationRef);
                const classId = await getValue(cellRefs.classRef);
                
                return {
                    account: account,
                    period: fromPeriod,
                    subsidiary: subsidiary,
                    department: department,
                    location: location,
                    class: classId
                };
                
            } catch (error) {
                console.error('Error resolving params:', error);
                return null;
            }
        }

        async function createDrillDownSheet(context, transactions, params) {
            const sheetName = `DrillDown_${params.account}`;
            
            let drillSheet;
            try {
                drillSheet = context.workbook.worksheets.getItem(sheetName);
                drillSheet.delete();
                await context.sync();
            } catch (e) {
                // Sheet doesn't exist
            }
            
            drillSheet = context.workbook.worksheets.add(sheetName);
            drillSheet.activate();
            
            // Header
            drillSheet.getRange('A1').values = [['TRANSACTION DRILL-DOWN']];
            drillSheet.getRange('A1').format.font.bold = true;
            drillSheet.getRange('A1').format.font.size = 14;
            
            drillSheet.getRange('A2').values = [[`Account: ${params.account} | Period: ${params.period}`]];
            drillSheet.getRange('A2').format.font.bold = true;
            
            // Column headers
            const headers = [['Date', 'Type', 'Number', 'Entity', 'Memo', 'Debit', 'Credit', 'Net Amount']];
            drillSheet.getRange('A4:H4').values = headers;
            drillSheet.getRange('A4:H4').format.font.bold = true;
            drillSheet.getRange('A4:H4').format.fill.color = '#667eea';
            drillSheet.getRange('A4:H4').format.font.color = 'white';
            
            // Data rows
            const dataRows = transactions.map(txn => [
                txn.transaction_date || '',
                txn.transaction_type || '',
                txn.transaction_number || '',
                txn.entity_name || '',
                txn.memo || '',
                txn.debit ? parseFloat(txn.debit) : 0,
                txn.credit ? parseFloat(txn.credit) : 0,
                txn.net_amount ? parseFloat(txn.net_amount) : 0
            ]);
            
            const dataRange = drillSheet.getRange(`A5:H${4 + dataRows.length}`);
            dataRange.values = dataRows;
            
            // Format currency
            drillSheet.getRange(`F5:H${4 + dataRows.length}`).numberFormat = [['$#,##0.00']];
            
            // Add hyperlinks
            for (let i = 0; i < transactions.length; i++) {
                const txn = transactions[i];
                const row = 5 + i;
                
                const linkCell = drillSheet.getRange(`C${row}`);
                const hyperlink = {
                    address: txn.netsuite_url,
                    textToDisplay: txn.transaction_number
                };
                linkCell.hyperlink = hyperlink;
                linkCell.format.font.color = '#0ea5e9';
                linkCell.format.font.underline = 'Single';
            }
            
            // Auto-fit
            drillSheet.getRange('A:H').format.autofitColumns();
            
            // Summary
            const summaryRow = 5 + dataRows.length + 2;
            drillSheet.getRange(`A${summaryRow}`).values = [[`Total Transactions: ${transactions.length}`]];
            drillSheet.getRange(`A${summaryRow}`).format.font.bold = true;
            
            const totalDebit = dataRows.reduce((sum, row) => sum + row[5], 0);
            const totalCredit = dataRows.reduce((sum, row) => sum + row[6], 0);
            const totalNet = dataRows.reduce((sum, row) => sum + row[7], 0);
            
            drillSheet.getRange(`E${summaryRow}`).values = [['Totals:']];
            drillSheet.getRange(`F${summaryRow}`).values = [[totalDebit]];
            drillSheet.getRange(`G${summaryRow}`).values = [[totalCredit]];
            drillSheet.getRange(`H${summaryRow}`).values = [[totalNet]];
            drillSheet.getRange(`E${summaryRow}:H${summaryRow}`).format.font.bold = true;
            drillSheet.getRange(`F${summaryRow}:H${summaryRow}`).numberFormat = [['$#,##0.00']];
            
            await context.sync();
        }
    </script>
</head>
<body>
    <!-- This file is used for command handlers only -->
</body>
</html>

