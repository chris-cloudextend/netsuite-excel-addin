<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XAVI Commands</title>
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
</head>
<body>
    <!-- Ultra-minimal page for ExecuteFunction - just signals taskpane.html to do the work -->
    <script>
        console.log('ðŸ“‹ commands.html loaded');
        
        /**
         * Context menu drill-down - MINIMAL implementation
         * We just store the cell info in localStorage and let taskpane.html do the actual work
         */
        function drillDownFromContextMenu(event) {
            console.log('=== CONTEXT MENU (commands.html) ===');
            
            // CRITICAL: Call event.completed() IMMEDIATELY to prevent debug window
            if (event && event.completed) {
                event.completed();
                console.log('âœ… event.completed() called');
            }
            
            // Store signal in localStorage for taskpane.html to pick up
            try {
                // Get selected cell info
                Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    const sheet = context.workbook.worksheets.getActiveWorksheet();
                    range.load(['formulas', 'values', 'address']);
                    sheet.load('name');
                    await context.sync();
                    
                    // Store the drill-down request for taskpane.html to handle
                    const request = {
                        timestamp: Date.now(),
                        address: range.address,
                        formula: range.formulas[0][0],
                        value: range.values[0][0],
                        sheetName: sheet.name
                    };
                    
                    localStorage.setItem('xavi_drilldown_request', JSON.stringify(request));
                    console.log('ðŸ“¤ Drill-down request stored:', request);
                    
                }).catch(err => {
                    console.error('Error storing drill-down request:', err);
                });
            } catch (err) {
                console.error('Error in drillDownFromContextMenu:', err);
            }
        }
        
        // Register immediately on window
        window.drillDownFromContextMenu = drillDownFromContextMenu;
        console.log('ðŸ“‹ drillDownFromContextMenu set on window');
        
        // Register with Office.actions when ready
        Office.onReady((info) => {
            console.log('ðŸ“‹ Office.onReady in commands.html');
            console.log('   Host:', info.host, 'Platform:', info.platform);
            
            if (Office.actions && Office.actions.associate) {
                Office.actions.associate("drillDownFromContextMenu", drillDownFromContextMenu);
                console.log('âœ… drillDownFromContextMenu registered');
            }
        });
    </script>
</body>
</html>
